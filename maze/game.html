<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NOS MAZE - Game</title>
    <meta name="description" content="æ­£åœ¨éŠç© NOS MAZE - æŒ‘æˆ°è¿·å®®ï¼Œæ¸¬è©¦ä½ çš„è§£è¬æŠ€å·§ï¼">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://noswork.github.io/maze/game.html">
    <meta property="og:title" content="NOS MAZE - éŠæˆ²é€²è¡Œä¸­">
    <meta property="og:description" content="æ­£åœ¨éŠç© NOS MAZE - æŒ‘æˆ°è¿·å®®ï¼Œæ¸¬è©¦ä½ çš„è§£è¬æŠ€å·§ï¼">
    <meta property="og:image" content="https://noswork.github.io/maze/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:locale" content="zh_TW">
    <meta property="og:site_name" content="NOS MAZE">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://noswork.github.io/maze/game.html">
    <meta name="twitter:title" content="NOS MAZE - éŠæˆ²é€²è¡Œä¸­">
    <meta name="twitter:description" content="æ­£åœ¨éŠç© NOS MAZE - æŒ‘æˆ°è¿·å®®ï¼Œæ¸¬è©¦ä½ çš„è§£è¬æŠ€å·§ï¼">
    <meta name="twitter:image" content="https://noswork.github.io/maze/og-image.png">
    
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="styles.css">
    <!-- é åŠ è¼‰ä¸»é¡Œå’Œèªè¨€ - é˜²æ­¢é–ƒçˆ -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('maze-theme') || 'light';
            const savedLang = localStorage.getItem('maze-lang') || 'zh';
            
            // è™•ç†ç³»çµ±ä¸»é¡Œ
            let actualTheme = savedTheme;
            if (savedTheme === 'system') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                actualTheme = prefersDark ? 'dark' : 'light';
            }
            
            document.documentElement.className = 'theme-' + actualTheme;
            document.documentElement.lang = savedLang === 'zh' ? 'zh-TW' : 'en';
            
            // å„²å­˜èªè¨€è¨­å®šä¾›å¾ŒçºŒä½¿ç”¨
            window.__MAZE_PRELOAD_LANG__ = savedLang;
            
            // å¼€å‘è°ƒè¯•ï¼šåœ¨é¡µé¢ä¸Šæ˜¾ç¤ºConsoleæ—¥å¿—
            if (window.location.search.includes('debug=1')) {
                window.__DEBUG_LOGS__ = [];
                
                // ç«‹å³åˆ›å»ºè°ƒè¯•é¢æ¿
                function createDebugPanel() {
                    let panel = document.getElementById('__debug_panel__');
                    if (!panel) {
                        panel = document.createElement('div');
                        panel.id = '__debug_panel__';
                        panel.style.cssText = 'position:fixed;bottom:0;left:0;right:0;height:150px;overflow-y:auto;background:#000;color:#0f0;font-size:11px;padding:8px;z-index:999999;font-family:monospace;border-top:3px solid #0f0;';
                        panel.innerHTML = '<div style="color:#ff0">ğŸ” è°ƒè¯•æ¨¡å¼å·²å¯åŠ¨...</div>';
                        
                        // ç¡®ä¿åœ¨DOMåŠ è½½åæ·»åŠ 
                        if (document.body) {
                            document.body.appendChild(panel);
                        } else {
                            document.addEventListener('DOMContentLoaded', () => {
                                document.body.appendChild(panel);
                            });
                        }
                    }
                    return panel;
                }
                
                const originalLog = console.log;
                const originalError = console.error;
                const originalWarn = console.warn;
                
                function updateDebugPanel() {
                    const panel = createDebugPanel();
                    const logs = window.__DEBUG_LOGS__.slice(-30);
                    panel.innerHTML = logs.map(l => 
                        `<div style="color:${l.type==='error'?'#f00':l.type==='warn'?'#ff0':'#0f0'};margin:2px 0;">${l.msg}</div>`
                    ).join('');
                    panel.scrollTop = panel.scrollHeight;
                }
                
                console.log = function(...args) {
                    originalLog.apply(console, args);
                    const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
                    window.__DEBUG_LOGS__.push({type: 'log', msg: msg});
                    updateDebugPanel();
                };
                
                console.error = function(...args) {
                    originalError.apply(console, args);
                    const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
                    window.__DEBUG_LOGS__.push({type: 'error', msg: 'âŒ ' + msg});
                    updateDebugPanel();
                };
                
                console.warn = function(...args) {
                    originalWarn.apply(console, args);
                    const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
                    window.__DEBUG_LOGS__.push({type: 'warn', msg: 'âš ï¸ ' + msg});
                    updateDebugPanel();
                };
                
                // ç«‹å³åˆ›å»ºé¢æ¿
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', createDebugPanel);
                } else {
                    createDebugPanel();
                }
                
                console.log('Debug mode activated!');
                
                // æ•è·æ‰€æœ‰é”™è¯¯
                window.addEventListener('error', (e) => {
                    console.error('Global Error: ' + e.message + ' at ' + e.filename + ':' + e.lineno);
                });
                
                window.addEventListener('unhandledrejection', (e) => {
                    console.error('Unhandled Promise Rejection: ' + e.reason);
                });
                
                // ç›‘æ§è„šæœ¬åŠ è½½
                document.addEventListener('DOMContentLoaded', () => {
                    console.log('DOM Content Loaded');
                    console.log('MAZE_TRANSLATIONS: ' + (typeof window.MAZE_TRANSLATIONS !== 'undefined' ? 'loaded' : 'NOT loaded'));
                    console.log('getMazeTranslation: ' + (typeof window.getMazeTranslation === 'function' ? 'exists' : 'NOT exists'));
                });
            }
        })();
    </script>
    <script src="i18n.js?v=8"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="supabase-config.js?v=8" defer></script>
    <script src="supabase-client.js?v=8" defer></script>
    <script type="module" src="scripts/game/index.js?v=8"></script>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <div class="game-header-left">
                <button class="header-nav-btn" id="backBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                    <span data-i18n="game.back">è¿”å›é¸å–®</span>
                </button>
            </div>
            <div class="game-info">
                <div id="stepCounter">
                    <span data-i18n="game.steps">æ­¥æ•°</span>: <span id="stepCount">0</span>
                </div>
                <div id="timer" style="display: none;">
                    <span data-i18n="game.time">æ—¶é—´</span>: <span id="timeDisplay">0:00</span>
                </div>
                <div id="mazeCounter" style="display: none;">
                    <span data-i18n="game.mazes">è¿·å®«</span>: <span id="mazeCount">0</span>
                </div>
            </div>
            <div class="game-header-right">
                <button class="pause-btn" id="pauseBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="pause-icon">
                        <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                    </svg>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="play-icon" style="display: none;">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </button>
            </div>
            <!-- éŠæˆ²é é¢ä¸é¡¯ç¤ºç”¨æˆ¶ç‹€æ…‹ -->
        </div>
        
        <div class="canvas-wrapper">
            <canvas id="gameCanvas"></canvas>
        </div>
        
        <div class="game-status" id="gameStatus"></div>
        
        <!-- Virtual D-Pad Controls -->
        <div class="dpad-container" id="dpadContainer">
            <button class="dpad-btn dpad-up" id="dpadUp" aria-label="Up">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M7 14l5-5 5 5z"/>
                </svg>
            </button>
            <div class="dpad-bottom-row">
                <button class="dpad-btn dpad-left" id="dpadLeft" aria-label="Left">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14 7l-5 5 5 5z"/>
                    </svg>
                </button>
                <button class="dpad-btn dpad-down" id="dpadDown" aria-label="Down">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7 10l5 5 5-5z"/>
                    </svg>
                </button>
                <button class="dpad-btn dpad-right" id="dpadRight" aria-label="Right">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10 17l5-5-5-5z"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Win Modal -->
        <div class="modal" id="winModal">
            <div class="modal-content">
                <h2 data-i18n="game.congrats">æ­å–œï¼</h2>
                <p id="winMessage"></p>
                <div class="modal-buttons">
                    <button class="menu-btn" id="winPlayAgainBtn">
                        <span data-i18n="game.playAgain">å†ç©ä¸€æ¬¡</span>
                    </button>
                    <button class="menu-btn secondary" id="winMenuBtn">
                        <span data-i18n="game.backMenu">è¿”å›é€‰å•</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Game Over Modal (for Race the Clock) -->
        <div class="modal" id="gameOverModal">
            <div class="modal-content">
                <h2 data-i18n="game.timeUp">æ—¶é—´åˆ°ï¼</h2>
                <p id="gameOverMessage">
                    <span data-i18n="game.completed">ä½ å®Œæˆäº†</span> <span id="finalCount">0</span> <span data-i18n="game.mazes">ä¸ªè¿·å®«</span>ï¼
                </p>
                <div class="modal-buttons">
                    <button class="menu-btn" id="gameOverPlayAgainBtn">
                        <span data-i18n="game.playAgain">å†ç©ä¸€æ¬¡</span>
                    </button>
                    <button class="menu-btn secondary" id="gameOverMenuBtn">
                        <span data-i18n="game.backMenu">è¿”å›é€‰å•</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner">
                <svg viewBox="0 0 100 100">
                    <!-- Maze pattern in background -->
                    <path class="maze-path" d="M20,20 L20,80 M30,20 L30,50 M30,60 L30,80 M40,20 L40,40 M40,60 L40,80 M50,20 L50,80 M60,20 L60,40 M60,60 L60,80 M70,30 L70,50 M70,60 L70,80 M80,20 L80,80"/>
                    <path class="maze-path" d="M20,20 L80,20 M20,30 L50,30 M60,30 L80,30 M20,40 L40,40 M60,40 L80,40 M20,50 L50,50 M60,50 L70,50 M20,60 L30,60 M50,60 L80,60 M20,70 L80,70 M20,80 L80,80"/>
                    <!-- Animated spinner circle -->
                    <circle class="spinner-path" cx="50" cy="50" r="35"/>
                </svg>
            </div>
        </div>

        <!-- Pause Modal -->
        <div class="modal" id="pauseModal">
            <div class="modal-content">
                <h2 data-i18n="game.paused">æ¸¸æˆå·²æš‚åœ</h2>
                <div class="modal-buttons">
                    <button class="menu-btn" id="resumeBtn">
                        <span data-i18n="game.resume">ç»§ç»­æ¸¸æˆ</span>
                    </button>
                    <button class="menu-btn secondary" id="pauseMenuBtn">
                        <span data-i18n="game.backMenu">è¿”å›é€‰å•</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
