<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 32 32%22><defs><linearGradient id=%22bg%22 x1=%220%25%22 y1=%220%25%22 x2=%22100%25%22 y2=%22100%25%22><stop offset=%220%25%22 style=%22stop-color:%23667eea%22/><stop offset=%22100%25%22 style=%22stop-color:%23764ba2%22/></linearGradient></defs><rect width=%2232%22 height=%2232%22 rx=%228%22 fill=%22url(%23bg)%22/><circle cx=%2216%22 cy=%2216%22 r=%228%22 fill=%22none%22 stroke=%22white%22 stroke-width=%222%22/><path d=%22M16 12v4l3 2%22 stroke=%22white%22 stroke-width=%222%22 stroke-linecap=%22round%22/></svg>">
    
    <!-- Meta Tags -->
    <meta name="description" content="å¤šäººå”ä½œçš„å¯¦æ™‚å€’è¨ˆæ™‚å·¥å…·ï¼Œæ”¯æ´åº§æ¨™è¼¸å…¥å’Œå°ç£æ™‚é–“é¡¯ç¤º">
    <meta name="keywords" content="å€’è¨ˆæ™‚,è¨ˆæ™‚å™¨,å¤šäººå”ä½œ,å¯¦æ™‚åŒæ­¥,å°ç£æ™‚é–“">
    <meta name="author" content="Countdown Timer App">
    
    <!-- Open Graph -->
    <meta property="og:title" content="å¤šäººå”ä½œå€’è¨ˆæ™‚å·¥å…·">
    <meta property="og:description" content="æ”¯æ´å¯¦æ™‚åŒæ­¥çš„åº§æ¨™å€’è¨ˆæ™‚ç®¡ç†å·¥å…·">
    <meta property="og:type" content="website">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>â° å¤šäººå”ä½œå€’è¨ˆæ™‚å·¥å…·</h1>
            <p>è¼¸å…¥åº§æ¨™å’Œæ™‚é–“ï¼Œå³æ™‚åŒæ­¥å€’è¨ˆæ™‚ç®¡ç† ğŸš€</p>
        </header>

        <!-- Main Content -->
        <div class="content">
            <!-- Input Panel -->
            <div class="input-panel">
                <div class="form-section">
                    <h3>ğŸ¯ æ–°å¢å€’è¨ˆæ™‚</h3>
                    <form id="countdown-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="coord-x">X åº§æ¨™</label>
                                <input type="number" id="coord-x" class="form-input" min="0" max="9999" placeholder="0" required>
                            </div>
                            <div class="form-group">
                                <label for="coord-y">Y åº§æ¨™</label>
                                <input type="number" id="coord-y" class="form-input" min="0" max="9999" placeholder="0" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>å€’è¨ˆæ™‚é–“</label>
                            <div class="time-inputs">
                                <input type="number" id="time-minutes" class="form-input" min="0" max="59" placeholder="åˆ†é˜" required>
                                <span class="time-separator">:</span>
                                <input type="number" id="time-seconds" class="form-input" min="0" max="59" placeholder="ç§’é˜" required>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn-primary">
                            â• é–‹å§‹å€’è¨ˆæ™‚
                        </button>
                    </form>
                    
                    <div id="error-message" class="error-message"></div>
                </div>

                <div class="form-section">
                    <h3>ğŸ”§ ç®¡ç†å·¥å…·</h3>
                    <button id="clear-all-btn" class="btn-danger" style="width: 100%;">
                        ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰å€’è¨ˆæ™‚
                    </button>
                </div>
            </div>

            <!-- Status Panel -->
            <div class="status-panel">
                <div class="status-header">
                    <h3>ğŸ“Š å€’è¨ˆæ™‚åˆ—è¡¨</h3>
                    <div class="connection-status">
                        <div class="status-indicator" id="connection-indicator"></div>
                        <span id="connection-text">é€£ç·šä¸­...</span>
                    </div>
                </div>
                
                <div class="countdown-list" id="countdown-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">â³</div>
                        <p>å°šç„¡å€’è¨ˆæ™‚é …ç›®<br>é–‹å§‹æ·»åŠ ç¬¬ä¸€å€‹å§ï¼</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // å¤šäººå”ä½œå€’è¨ˆæ™‚å·¥å…·
        class CountdownManager {
            constructor() {
                this.socket = io();
                this.countdowns = [];
                this.updateInterval = null;
                
                this.setupSocketEvents();
                this.setupUIEvents();
                this.startUpdating();
                
                console.log('ğŸš€ å€’è¨ˆæ™‚ç®¡ç†å·¥å…·å·²åˆå§‹åŒ–');
            }

            setupSocketEvents() {
                // é€£æ¥ç‹€æ…‹
                this.socket.on('connect', () => {
                    this.updateConnectionStatus(true);
                    console.log('âœ… å·²é€£æ¥åˆ°æœå‹™å™¨');
                });

                this.socket.on('disconnect', () => {
                    this.updateConnectionStatus(false);
                    console.log('âŒ èˆ‡æœå‹™å™¨æ–·é–‹é€£æ¥');
                });

                this.socket.on('connect_error', (error) => {
                    this.updateConnectionStatus(false);
                    console.error('ğŸ”Œ é€£æ¥éŒ¯èª¤:', error);
                });

                // å€’è¨ˆæ™‚äº‹ä»¶
                this.socket.on('countdown-list', (countdowns) => {
                    this.countdowns = countdowns;
                    this.renderCountdowns();
                    console.log(`ğŸ“‹ æ”¶åˆ° ${countdowns.length} å€‹å€’è¨ˆæ™‚é …ç›®`);
                });

                this.socket.on('countdown-added', (countdown) => {
                    this.countdowns.push(countdown);
                    this.sortCountdowns();
                    this.renderCountdowns();
                    console.log(`â• æ–°å¢å€’è¨ˆæ™‚: (${countdown.x},${countdown.y})`);
                });

                this.socket.on('countdown-removed', (data) => {
                    this.countdowns = this.countdowns.filter(c => c.id !== data.id);
                    this.renderCountdowns();
                    console.log(`ğŸ—‘ï¸ ç§»é™¤å€’è¨ˆæ™‚ ID: ${data.id}`);
                });

                this.socket.on('countdowns-cleared', () => {
                    this.countdowns = [];
                    this.renderCountdowns();
                    console.log('ğŸ§¹ æ‰€æœ‰å€’è¨ˆæ™‚å·²æ¸…ç©º');
                });

                // éŒ¯èª¤è™•ç†
                this.socket.on('error', (data) => {
                    this.showError(data.message);
                    console.error('âŒ æœå‹™å™¨éŒ¯èª¤:', data.message);
                });

                // ç”¨æˆ¶äº‹ä»¶
                this.socket.on('user-joined', (user) => {
                    console.log(`ğŸ‘‹ ${user.name} åŠ å…¥äº†`);
                });

                this.socket.on('user-left', (userId) => {
                    console.log(`ğŸ‘‹ ç”¨æˆ¶ ${userId} é›¢é–‹äº†`);
                });
            }

            setupUIEvents() {
                // è¡¨å–®æäº¤
                const form = document.getElementById('countdown-form');
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addCountdown();
                });

                // æ¸…ç©ºæ‰€æœ‰æŒ‰éˆ•
                const clearBtn = document.getElementById('clear-all-btn');
                clearBtn.addEventListener('click', () => {
                    if (confirm('âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å€’è¨ˆæ™‚å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                        this.socket.emit('clear-all');
                    }
                });

                // è¼¸å…¥é©—è­‰å’Œæ ¼å¼åŒ–
                const inputs = form.querySelectorAll('input[type="number"]');
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        this.hideError();
                        
                        // è‡ªå‹•æ ¼å¼åŒ–æ™‚é–“è¼¸å…¥
                        if (input.id === 'time-seconds' || input.id === 'time-minutes') {
                            let value = parseInt(input.value);
                            if (value > 59) {
                                input.value = 59;
                            } else if (value < 0) {
                                input.value = 0;
                            }
                        }
                        
                        // åº§æ¨™ç¯„åœé™åˆ¶
                        if (input.id === 'coord-x' || input.id === 'coord-y') {
                            let value = parseInt(input.value);
                            if (value > 9999) {
                                input.value = 9999;
                            } else if (value < 0) {
                                input.value = 0;
                            }
                        }
                    });
                    
                    // Enter éµå¿«é€Ÿæäº¤
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            form.dispatchEvent(new Event('submit'));
                        }
                    });
                });

                // é é¢å¤±ç„¦æ™‚é¡¯ç¤ºé€šçŸ¥
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.countdowns.length > 0) {
                        console.log('ğŸ“± é é¢å·²éš±è—ï¼Œå€’è¨ˆæ™‚ç¹¼çºŒé‹è¡Œ');
                    }
                });
            }

            addCountdown() {
                const x = parseInt(document.getElementById('coord-x').value);
                const y = parseInt(document.getElementById('coord-y').value);
                const minutes = parseInt(document.getElementById('time-minutes').value) || 0;
                const seconds = parseInt(document.getElementById('time-seconds').value) || 0;

                // å‰ç«¯é©—è­‰
                if (isNaN(x) || isNaN(y) || x < 0 || y < 0) {
                    this.showError('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„åº§æ¨™ (0-9999)');
                    return;
                }

                if (minutes < 0 || seconds < 0 || minutes > 59 || seconds > 59) {
                    this.showError('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„æ™‚é–“ (0-59)');
                    return;
                }

                if (minutes === 0 && seconds === 0) {
                    this.showError('âŒ æ™‚é–“å¿…é ˆå¤§æ–¼ 0');
                    return;
                }

                // æª¢æŸ¥æ˜¯å¦å·²é€£æ¥
                if (!this.socket.connected) {
                    this.showError('âŒ èˆ‡æœå‹™å™¨æ–·é–‹é€£æ¥ï¼Œè«‹ç¨å¾Œé‡è©¦');
                    return;
                }

                // ç™¼é€åˆ°æœå‹™å™¨
                this.socket.emit('add-countdown', { x, y, minutes, seconds });

                // æ¸…ç©ºè¡¨å–®
                document.getElementById('countdown-form').reset();
                this.hideError();
                
                console.log(`ğŸ“¤ ç™¼é€å€’è¨ˆæ™‚: (${x},${y}) ${minutes}:${seconds.toString().padStart(2, '0')}`);
            }

            removeCountdown(id) {
                if (!this.socket.connected) {
                    this.showError('âŒ èˆ‡æœå‹™å™¨æ–·é–‹é€£æ¥');
                    return;
                }
                this.socket.emit('remove-countdown', { id });
            }

            sortCountdowns() {
                const now = Date.now();
                this.countdowns.sort((a, b) => {
                    const aRemaining = Math.max(0, a.endTime - now);
                    const bRemaining = Math.max(0, b.endTime - now);
                    
                    // æœªéæœŸçš„æ’åœ¨å‰é¢ï¼ŒæŒ‰å‰©é¤˜æ™‚é–“å‡åº
                    if (aRemaining > 0 && bRemaining > 0) {
                        return aRemaining - bRemaining;
                    }
                    
                    // éæœŸçš„æ’åœ¨å¾Œé¢ï¼ŒæŒ‰éæœŸæ™‚é–“é™åº
                    if (aRemaining === 0 && bRemaining === 0) {
                        return b.endTime - a.endTime;
                    }
                    
                    // æœªéæœŸçš„åœ¨å‰
                    return bRemaining - aRemaining;
                });
            }

            renderCountdowns() {
                const container = document.getElementById('countdown-list');
                
                if (this.countdowns.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">â³</div>
                            <p>å°šç„¡å€’è¨ˆæ™‚é …ç›®<br>é–‹å§‹æ·»åŠ ç¬¬ä¸€å€‹å§ï¼</p>
                        </div>
                    `;
                    return;
                }

                this.sortCountdowns();
                
                container.innerHTML = this.countdowns.map(countdown => {
                    const now = Date.now();
                    const remaining = Math.max(0, countdown.endTime - now);
                    const isExpired = remaining === 0;
                    const isWarning = remaining > 0 && remaining <= 60000; // æœ€å¾Œ1åˆ†é˜è­¦å‘Š
                    
                    return this.createCountdownHTML(countdown, remaining, isExpired, isWarning);
                }).join('');

                // æ·»åŠ ç§»é™¤æŒ‰éˆ•äº‹ä»¶
                container.querySelectorAll('.remove-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = parseInt(btn.dataset.id);
                        if (confirm('ç¢ºå®šè¦ç§»é™¤é€™å€‹å€’è¨ˆæ™‚å—ï¼Ÿ')) {
                            this.removeCountdown(id);
                        }
                    });
                });
            }

            createCountdownHTML(countdown, remaining, isExpired, isWarning) {
                const endTimeStr = this.formatDateTime(new Date(countdown.endTime));
                const timerText = isExpired ? 'â° å·²çµæŸ' : this.formatTime(remaining);
                const itemClass = isExpired ? 'expired' : (isWarning ? 'warning' : '');
                const timerClass = isExpired ? 'expired' : (isWarning ? 'warning' : '');

                return `
                    <div class="countdown-item ${itemClass} fade-in">
                        <div class="countdown-header">
                            <div class="countdown-coordinates">ğŸ“ (${countdown.x}, ${countdown.y})</div>
                            <button class="remove-btn" data-id="${countdown.id}" title="ç§»é™¤å€’è¨ˆæ™‚">Ã—</button>
                        </div>
                        <div class="countdown-timer ${timerClass}">${timerText}</div>
                        <div class="countdown-info">
                            <div class="countdown-author">
                                <span class="author-badge" style="background-color: ${countdown.createdByColor}"></span>
                                ${countdown.createdBy}
                            </div>
                            <div class="countdown-endtime">ğŸ• ${endTimeStr}</div>
                        </div>
                    </div>
                `;
            }

            formatTime(milliseconds) {
                const totalSeconds = Math.floor(milliseconds / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            formatDateTime(date) {
                // å°ç£æ™‚é–“æ ¼å¼åŒ–
                return date.toLocaleString('zh-TW', {
                    timeZone: 'Asia/Taipei',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            }

            startUpdating() {
                // æ¯ç§’æ›´æ–°ä¸€æ¬¡é¡¯ç¤º
                this.updateInterval = setInterval(() => {
                    if (this.countdowns.length > 0) {
                        this.renderCountdowns();
                    }
                }, 1000);
            }

            updateConnectionStatus(connected) {
                const indicator = document.getElementById('connection-indicator');
                const text = document.getElementById('connection-text');
                
                if (connected) {
                    indicator.classList.remove('disconnected');
                    text.textContent = 'ğŸŸ¢ å·²é€£ç·š';
                } else {
                    indicator.classList.add('disconnected');
                    text.textContent = 'ğŸ”´ é€£ç·šä¸­æ–·';
                }
            }

            showError(message) {
                const errorDiv = document.getElementById('error-message');
                errorDiv.textContent = message;
                errorDiv.classList.add('show');
                
                // 5ç§’å¾Œè‡ªå‹•éš±è—
                setTimeout(() => {
                    this.hideError();
                }, 5000);
            }

            hideError() {
                const errorDiv = document.getElementById('error-message');
                errorDiv.classList.remove('show');
            }
        }

        // åˆå§‹åŒ–æ‡‰ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ¯ æ­£åœ¨åˆå§‹åŒ–å¤šäººå”ä½œå€’è¨ˆæ™‚å·¥å…·...');
            window.countdownManager = new CountdownManager();
        });

        // PWA æ”¯æ´
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                console.log('ğŸ”§ Service Worker æ”¯æ´å·²æª¢æ¸¬');
            });
        }
    </script>
</body>
</html>