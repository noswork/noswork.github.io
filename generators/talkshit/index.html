<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>幹話生成器 Pro — 本地/AI、關鍵字嵌入、成人模式、圖片導出</title>
  <meta name="description" content="雙模幹話生成器：豐富語料與模板、成人模式（雙關/露骨 18+）、AI 預設提示詞、關鍵字嵌入、圖片導出（高解析、可調排版）。" />
  <link rel="stylesheet" href="talkshit.css" />
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>幹話生成器 Pro</h1>
          <small>雙模 × 主題 × 關鍵字 × 成人模式 × 高畫質圖片</small>
        </div>
      </div>
      <div class="switches">
        <div class="switch">
          <details id="aiDetails">
            <summary>AI 模式</summary>
            <div class="popover">
              <div class="row-compact">
                <div class="switch"><input type="checkbox" id="aiEnabled" /><label for="aiEnabled">啟用 AI</label></div>
                <div>
                  <label>API Key</label>
                  <input id="apiKey" type="password" placeholder="sk-****************" />
                </div>
                <details class="more">
                  <summary>更多設定</summary>
                  <div class="grid-2">
                    <div>
                      <label>API Base URL</label>
                      <input id="apiBase" type="text" value="https://api.openai.com/v1" />
                    </div>
                    <div>
                      <label>Model</label>
                      <input id="apiModel" type="text" value="gpt-4o-mini" />
                    </div>
                    <div>
                      <label>句數</label>
                      <input id="aiCount" type="number" min="1" max="20" value="6" />
                    </div>
                    <div>
                      <label>創意度（temperature）</label>
                      <input id="aiTemp" type="range" min="0" max="100" value="70" />
                    </div>
                    <div>
                      <label>去重</label>
                      <select id="aiDedupe">
                        <option value="soft">適度</option>
                        <option value="strict">嚴格</option>
            <option value="off">關閉</option>
          </select>
                    </div>
                  </div>
                </details>
              </div>
            </div>
          </details>
        </div>
        <div class="switch">
          <details id="adultDetails">
            <summary>成人模式（18+）</summary>
            <div class="popover">
              <div class="switch"><input type="checkbox" id="adultOn" /><label for="adultOn">啟用成人模式</label></div>
              <div class="switch"><input type="checkbox" id="adultFull" /><label for="adultFull">火力全開（最露骨）</label></div>
              <label>自訂成人 System 提示詞（可留空，另含預設於 prompts.js）</label>
              <textarea id="adultCustomPrompt" placeholder="在此覆寫成人預設提示詞"></textarea>
        </div>
          </details>
      </div>

      </div>
    </header>

    <div class="card">
      <div id="panel-local" class="panel">
        <div class="controls">
          <div class="col-6">
            <label>主題分類</label>
            <select id="theme">
              <optgroup label="一般">
                <option value="random">隨機</option>
                <option value="custom">自定義</option>
                <option value="哲理雞湯">哲理雞湯</option>
                <option value="社會冷笑話">社會冷笑話</option>
                <option value="情感">情感</option>
                <option value="自嘲">自嘲</option>
                <option value="職場">職場</option>
                <option value="人生">人生</option>
                <option value="友情">友情</option>
                <option value="押韻對仗">押韻對仗</option>
                <option value="科技宅">科技宅</option>
                <option value="電競遊戲">電競/遊戲</option>
                <option value="健身">健身</option>
                <option value="理財">理財</option>
                <option value="旅行">旅行</option>
                <option value="美食">美食</option>
                <option value="校園畢業">校園/畢業</option>
                <option value="迷因學">迷因學</option>
                <option value="毒雞湯">毒雞湯（辛辣）</option>
                <option value="社群媒體">社群媒體</option>
                <option value="內耗">內耗</option>
                <option value="通勤">通勤</option>
                <option value="上班摸魚">上班摸魚</option>
                <option value="面試">面試</option>
                <option value="創業">創業</option>
                <option value="熬夜早八">熬夜/早八</option>
                <option value="養生">養生</option>
                <option value="咖啡">咖啡</option>
                <option value="書影音">書影音</option>
                <option value="專案管理">專案管理</option>
              </optgroup>
              <optgroup label="成人（需開啟成人模式）">
                <option value="成人-雙關">成人-雙關</option>
                <option value="成人-露骨">成人-露骨（18+）</option>
              </optgroup>
            </select>
            <small class="muted">成人主題需開啟上方「成人模式」</small>
          </div>
          <div class="col-6">
            <label>自訂主題（選「自定義」後可輸入）</label>
            <input id="themeCustom" type="text" placeholder="例如：畢業、尾牙、減肥、{朋友名字}" disabled />
          </div>
          <div class="col-6">
            <label>關鍵字（名詞）</label>
            <input id="keyword" type="text" placeholder="例如：阿宏、保溫瓶、滑鼠、KPI"/>
          </div>
          <div class="col-6">
            <label>輸出格式</label>
            <select id="format">
              <option value="single">單句</option>
              <option value="list">清單（多句）</option>
              <option value="paragraph">段落（多句合成）</option>
              <option value="couplet">對聯（上聯/下聯）</option>
              <option value="poster">海報文案（短句 × N）</option>
            </select>
          </div>
          <div class="col-6">
            <label>輸出風格</label>
            <select id="style">
              <option value="正常">正常</option>
              <option value="custom">自定義</option>
              <option value="詩意">詩意</option>
              <option value="毒舌">毒舌</option>
              <option value="台味">台味</option>
              <option value="黑色幽默">黑色幽默</option>
              <option value="文青">文青</option>
              <option value="勵志">勵志</option>
              <option value="冷面">冷面</option>
              <option value="浮誇">浮誇</option>
            </select>
          </div>
          <div class="col-6">
            <label>自定義風格（選「自定義」後可輸入）</label>
            <input id="styleCustom" type="text" placeholder="例如：毒舌、詩意、台味、黑色幽默" disabled />
          </div>
          <div class="col-4">
            <label id="countLabel">數量/句數</label>
            <input id="count" type="number" min="1" max="20" value="4" />
          </div>
          <div class="col-4">
            <label>創意度</label>
            <input id="creativity" type="range" min="0" max="100" value="60" />
            <small class="muted">越高越飛，越低越穩</small>
          </div>
          <div class="col-4">
            <label>輸出去重</label>
            <select id="dedupe">
              <option value="soft">適度</option>
              <option value="strict">嚴格</option>
              <option value="off">關閉</option>
            </select>
          </div>
          <div class="col-12">
            <small class="muted">提示：單句與對聯會固定句數；清單、段落、海報文案會依「數量/句數」輸出。</small>
          </div>
        </div>
        <div class="btns">
          <button class="btn-primary" id="btn-gen-local">生成文字</button>
          <button id="btn-rand">隨機設定</button>
          <button id="btn-clear">清空</button>
        </div>
      </div>

      
    </div>

    <div class="row">
      <div class="card">
        
        <div class="monitor" aria-live="polite">
          <div class="monitor-top" aria-hidden="true">
            <span class="dot red"></span>
            <span class="dot yellow"></span>
            <span class="dot green"></span>
        </div>
          <div class="screen">
            <pre id="output" class="screen-content"></pre>
          </div>
          </div>
        <div class="btns" style="margin-top:10px">
            <button class="btn-copy" id="btn-copy-all">一鍵複製</button>
          </div>
          </div>

      
    </div>

    <div class="footer">
      <div>
        小叮嚀：本工具僅供娛樂，請避免用於人身攻擊或騷擾。成人模式僅限成年人自願情境，禁止涉及未成年人、亂倫、獸交或任何非自願行為。
      </div>
      <div>
        Made with <span class="hl">HTML/CSS/JS</span> · 所有生成於本地執行
      </div>
    </div>

    <div class="toast" id="toast">已複製</div>
  </div>

  <script type="module">
    import { buildSystemPromptFromState } from './prompts.js';
    import { typeLines } from './talkshit.js';
    // =============== 工具函式 ===============
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
    const toast = (msg)=>{const t=$("#toast");t.textContent=msg;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),1200)}
    const toastLoading = (msg)=>{const t=$("#toast");t.textContent=msg;t.classList.add("show","spinner");};
    const toastDone = ()=>{const t=$("#toast");t.classList.remove("spinner");setTimeout(()=>t.classList.remove("show"),400)};
    const rand=(n)=>Math.floor(Math.random()*n);
    const pick=(arr)=>arr[rand(arr.length)];
    const shuffle=(arr)=>arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    const uniq=(arr)=>Array.from(new Set(arr));
    const sample=(arr,n)=>shuffle(arr).slice(0,Math.min(arr.length,n));
    const byId=(id)=>document.getElementById(id);
    const setLocal=(k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} };
    const getLocal=(k, def=null)=>{ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): def; }catch(e){ return def; } };
    // 標點修復/正規化
    const normalizePunctuation = (s)=>{
      if(!s) return s;
      let out = s;
      // 英文標點轉全形中文（保守轉換）
      out = out.replace(/!/g,'！').replace(/\?/g,'？').replace(/,/g,'，').replace(/;/g,'；');
      // 句末句點：將非數字小數點的句末或空白後句點轉換為全形
      out = out.replace(/\.(?=\s|$)/g,'。');
      // 去除標點前多餘空格
      out = out.replace(/\s+([，。；！？])/g,'$1');
      // 若句末無結尾標點，補上句號
      const trimmed = out.trim();
      if(trimmed && !/[。！？!]$/.test(trimmed)) out = trimmed + '。';
      return out;
    };
    const sanitizeLines = (lines)=> lines.map((s)=> normalizePunctuation(s));
    const sanitizeTextByFormat = (text, format)=>{
      if(format === 'paragraph') return normalizePunctuation(text);
      const arr = text.split(/\n/).map(normalizePunctuation);
      return arr.join('\n');
    };

    // =============== 關鍵字替換 ===============
    function replaceSmart(str, map){
      // [a|b|c] 隨機分支
      str = str.replace(/\[([^\]]+)\]/g, (_, inside)=>{
        const opts = inside.split("|").map(s=>s.trim());
        return pick(opts);
      });
      // {占位}
      str = str.replace(/\{(\w+)\}/g, (_, k)=>{
        if (map[k] != null && map[k] !== "") return map[k];
        if (k === "KW") return pick(["這件事","那個東西","它","某個傳說","這波操作"]);
        if (k === "THEME") return map["THEME"] || "人生";
        if (k === "NOUN") return pick(LEX.NOUN);
        if (k === "ADJ") return pick(LEX.ADJ);
        if (k === "VERB") return pick(LEX.VERB);
        if (k === "EMOJI") return pick(LEX.EMOJI);
        if (k === "SAFEWORD") return map["KW"] || pick(["鳳梨","芝士","薄荷","海鹽"]);
        return "";
      });
      return str;
    }

    // =============== 詞庫 ===============
    const LEX = {
      NOUN: [
        "人生","世界","社會","現實","理想","選擇","命運","風向","底線","原則","套路","劇情","段位","初心",
        "規則","邏輯","儀式感","夢想","體面","秩序","節奏","誤會","默契","時間","天賦","運氣","格局","野心",
        "KPI","OKR","報表","靈感","流量","情緒","友情","愛情","訊號","回憶","段子","梗","火候","底蘊","樂子","算法","邊界",
        "身材管理","睡眠品質","專注力","自控力","輸出","人設","敘事","門檻","工位","週報","通勤卡","會議室","咖啡因","熬夜費",
        "體脂率","褪黑素","專案","甘特圖","打卡機","工時","情緒價值","需求文檔","路線圖","指標"
      ],
      ADJ: [
        "複雜","離譜","抽象","輕盈","沉重","虛無","體面","篤定","克制","通透","縝密","微妙","浮誇","穩重","上頭","清醒","佛系","社恐",
        "高冷","熱鬧","不講理","玄學","靈性","柔軟","硬核","保守","激進","進退兩難","莫名其妙","語焉不詳","欲言又止",
        "含蓄","直接","尖銳","平靜","克難","養生","焦慮","低調","高調","碎裂","乾脆","穩妥"
      ],
      VERB: [
        "扛著","拿捏","對齊","糊弄","繞開","共鳴","誤解","對賭","對線","對沖","對標","復盤","拆解","反思","交差","交卷",
        "續命","充電","上香","躺平","內卷","出圈","出戲","破防","托底","提氣","開香檳","排雷","背鍋","打點","打磨","補課","卡點",
        "打卡","摸魚","請假","補眠","安利","踩坑"
      ],
      EMOJI: ["🤡","🫠","🥲","🤔","😶‍🌫️","🫥","😵‍💫","🙃","😮‍💨","🫨","💭","✨","💤","🔥","🌪️","🌫️","🌊","🧊","🥶","😶","🤫","🫡","🤷","🧠","📈","📉","🎲","🧩","🍻","🎯","☕","📅","🚌","🛌"]
    };

    // =============== 語料庫（一般/新增主題） ===============
    const CORPUS = {
      "哲理雞湯": [
        "天黑路滑，社會複雜。",
        "不是誰離不開誰，是誰放不下誰。",
        "走過青春的夏天，誰還記得曾是哪年？",
        "希望似火，失望如煙，人生如七處點火，八處冒煙。",
        "漫漫人生路，一直在迷路。",
        "世界不骯髒，何來的悲傷？",
        "我們都是遠視眼，模糊了離我們最近的幸福。",
        "志在山頂的人，不會貪念山腰的風景。",
        "那個允許揮霍的年代叫青春。",
        "別拿青春賭明天，輸了就沒有明天了。",
        "愛情像鬼，相信的人多，但見到的人少。",
        "一個人炫耀什麼，內心就缺少什麼。",
        "握不住的沙，乾脆揚了它。",
        "道理我都懂，就是不想照做。",
        "別和現實爭辯，它會用時間把你說服。",
        "當然會猶豫，因為每條路我都想成了死路。",
        "有人靠天賦，有人靠努力，我靠{KW}的運氣。"
      ],
      "社會冷笑話": [
        "廣告就是告訴別人，錢也可以這麼花。",
        "和人接觸久了就越來越喜歡狗，狗永遠是狗，人有時不是人。",
        "花有百般紅，人與狗不同。",
        "不願做奴隸的人民，願意做人民幣的奴隸。",
        "迪廳滿座，是因為人心寂寞。",
        "又帥又車，那是象棋；又錢又房，那是銀行。",
        "力的作用是相互的，除了愛情的力量。",
        "別人靠資源，我靠情緒價值和{KW}。",
        "{KW}像KPI：看起來有指標，實際上沒有指路。",
        "懂的人在會議外，會議裡的人都在懂裝懂。"
      ],
      "情感": [
        "不是誰離不開誰，是誰放不下誰。",
        "女人長得漂亮是優勢，活得漂亮是本事。",
        "令人難以自拔的，除了牙齒還有愛情。",
        "人生像打電話，不是你先掛就是我先掛。",
        "要輸就輸給追求，要嫁就嫁給幸福。",
        "希望你被溫柔以待，也偶爾被現實提醒。",
        "{KW}像備用電池，用到的時候才想起重要。",
        "喜歡是藏不住的，像手機震動，隔著{NOUN}都能聽見。",
        "分手不是輸，是讓彼此贏回自尊的贏。"
      ],
      "自嘲": [
        "我視金錢為糞土，我爸視我為化糞池。",
        "混到現在拿得起放得下的只有筷子了。",
        "我長得很耐看，你得耐心看。",
        "我可以放棄選擇，但不能選擇放棄。",
        "小時候我把玩具當朋友，長大後朋友把我當玩具。",
        "別人是天選之人，我是天選之謎。",
        "{KW}沒問題，問題是我。",
        "努力不是為了出頭，是為了不出糗。",
        "我不是不行，是不太行，但先行禮如儀。"
      ],
      "職場": [
        "KPI是個好東西，大家都懂，誰都過不了。",
        "會議像海：聲浪很大，漲潮退潮都和{KW}無關。",
        "以為在復盤，其實在複讀；以為在對齊，其實在對付。",
        "進度像月亮，初一十五不一樣。",
        "懂的不說，說的不懂，懂說的都不在會議裡。",
        "{KW}排期很滿，落地很空。",
        "躺平是戰術，續命是主業。",
        "報表會寫故事，績效喜歡聽童話。",
        "需求不難，難在需求方說人話。"
      ],
      "人生": [
        "握不住的沙，乾脆揚了它。",
        "只做第一個我，不做第二個誰。",
        "志在山頂的人，不會貪念山腰的風景。",
        "{KW}不是全部，卻總能把局面改個名字。",
        "我們都在尋找路，其實路也在觀察我們。",
        "有些事情無須爭辯，表面服從，偷偷反抗。",
        "別把真心話說太滿，把幹話留點空。"
      ],
      "友情": [
        "朋友就是：不說廢話的時候心照不宣，說起廢話的時候一拍即合。",
        "在場的都懂我意思，不在場的更懂我的幹話。",
        "一起裝瘋賣傻的，才配叫{KW}那批人。",
        "和你說大道理是禮貌，和你說幹話才是親密。",
        "乾了這杯白開水，為今天不想努力的我們。"
      ],
      "押韻對仗": [
        "天高任我飛，地厚接我墜。",
        "喝水不忘挖井人，吃土不忘房貸人。",
        "上聯：{KW}不動如山；下聯：嘴上風生水起。",
        "上聯：選擇困難症；下聯：症狀選擇困難。",
        "上聯：道理都懂沒用；下聯：情緒到位就行。",
        "上聯：理想裝口袋；下聯：現實塞滿格。"
      ],
      "科技宅": [
        "{KW}像緩存，清了以後才發現自己才是瓶頸。",
        "我不是拖延，我在等待最佳編譯時間。",
        "問題不在bug，在於我把生活當debug。",
        "人生不是二進位，卻總在0和1之間卡住。",
        "我不是宅，我是低延遲生活實踐者。",
        "今天的靈感交給明天的我合併衝突。",
        "人際關係像微服務，故障時都怪網路。",
        "別問我愛不愛你，先問系統給不給權限。"
      ],
      "電競遊戲": [
        "又帥又車那是象棋，我是又菜又愛玩那種。",
        "輸贏不重要，重要的是輸得有畫面。",
        "{KW}像CD，急也急不來。",
        "排位像人生：連跪時，全怪隊友；連勝時，都是實力。",
        "別研究版本答案了，研究怎麼活下來比較靠譜。",
        "操作拉滿，腦子待機。",
        "坑是大家的，鍋是我的。"
      ],
      "健身": [
        "別人流汗是發光，我流汗是續命。",
        "自律不是把甜點戒掉，是把{KW}換成零卡。",
        "今天不練，明天徒傷悲。",
        "三分練七分吃，還有九十分想太多。",
        "肌肉是存款，脂肪是通膨。",
        "握住啞鈴像握住人生：沉重但安心。",
        "腹肌在路上，外賣也在路上。"
      ],
      "理財": [
        "理財的第一步是認清：{KW}不是資產，是情緒。",
        "省的是雞毛，花的是鷹揚。",
        "投資講紀律，吃土講氣質。",
        "基金是定投，人生是定痛。",
        "我不是抄底，我是抄作業。",
        "漲了是眼光，跌了是眼淚。"
      ],
      "旅行": [
        "說走就走的是旅行，說睡就睡的是我。",
        "風景不會說話，但很會安慰人。",
        "迷路是旅行的主線任務。",
        "{KW}像行李：帶上了，才知道沉不沉。",
        "攻略做得再好，也擋不住遇見的巧合。",
        "出發之前，先把心情check-in。"
      ],
      "美食": [
        "人生已經很苦了，{KW}請加倍甜。",
        "吃不飽哪有力氣做夢？",
        "熱量是暫時的，快樂是永久的。",
        "沒有被食物治癒的夜晚，只配被外賣治癒。",
        "卡路里是幹話的燃料。"
      ],
      "校園畢業": [
        "走過青春的夏天，誰還記得曾是哪年？",
        "{KW}像畢業照：拍得很笑，放得很久。",
        "上課像長跑，下課像自由落體。",
        "作業和愛情一樣：拖到最後才有靈感。",
        "青春是允許揮霍的年代，揮霍完了叫履歷。",
        "離開校園才懂，鈴聲是最好的OKR。"
      ],
      "迷因學": [
        "證明自己不靠事實，靠流量。",
        "大家都在線上，只有我在線下的下。",
        "把道理做成貼紙，貼到{KW}上它就有用了。",
        "先畫餅再上菜，味道自然不重要。",
        "情緒到位，邏輯就地慰問。",
        "我在輸出價值的路上，結果輸出了表情包。"
      ],
      "毒雞湯": [
        "累嗎？累就對了，舒服是留給死人的。",
        "只要監獄不黃，我就繼續猖狂。",
        "我命由我不由天，天要滅我我滅天。",
        "你說的不是建議，是回音；我回的是禮貌，不是答案。",
        "當面溫柔，背地裡各自清醒。",
        "成年人的快樂像早八的鬧鐘，響了還是裝沒聽見。",
        "內耗是免費續命包，吃了更累還停不下來。",
        "上班像健身，練的是抗打擊能力。"
      ],
      "社群媒體": [
        "別把生活過得像限時動態，24小時就過期。",
        "演算法喜歡我焦慮的樣子，因為會多滑幾頁。",
        "發文不是輸出價值，是輸出存在感。",
        "{KW}配濾鏡都漂亮，不配邏輯也能火。"
      ],
      "內耗": [
        "我白天和世界對線，晚上和自己對峙。",
        "最會拖累我的人，是我。",
        "{KW}不是難題，腦內小劇場才是。",
        "把選擇做成選秀，最後投票的是焦慮。"
      ],
      "通勤": [
        "車在動，我在不動，進度在原地踏步。",
        "通勤像長跑，終點只有打卡機。",
        "地鐵播報是提醒，我還在過昨天。",
        "{KW}塞在路上，我塞在情緒裡。"
      ],
      "上班摸魚": [
        "工作量像潮汐，摸魚是治水工程。",
        "我不是不努力，我在等待合適的摸魚檔期。",
        "摸魚不是偷懶，是給靈感續命。",
        "{KW}先擱著，先把狀態養好。"
      ],
      "面試": [
        "我擅長的技能有：把廢話說成人話，把人話說成幹話。",
        "自我介紹像是PPT，我是那張過渡頁。",
        "優點是會復盤，缺點是會過度復盤。",
        "{KW}經驗豐富，主要豐富在想像力。"
      ],
      "創業": [
        "創業是把不確定性養成寵物，天天喂它錢。",
        "融資像約會，彼此都怕彼此有更好選擇。",
        "現金流是KPI的媽媽。",
        "{KW}不是商業模式，是生存模式。"
      ],
      "熬夜早八": [
        "早八是鬧鐘，熬夜是信仰。",
        "我把睡眠交給未來的我處理。",
        "凌晨的靈感值錢，白天的狀態要命。",
        "{KW}明天再說，今天先不說。"
      ],
      "養生": [
        "保溫杯裡泡枸杞，嘴上說著隨緣。",
        "維他命補的是心安。",
        "{KW}少一點，早睡多一點，焦慮少一點。",
        "運動不是減壓，是在壓力裡找氧氣。"
      ],
      "咖啡": [
        "第一杯是醒來用的，第二杯是活著用的。",
        "加奶不加糖，因為生活已經夠甜了沒有。",
        "{KW}像咖啡因，先讓人上頭，再讓人心悸。",
        "今天的我由美式驅動。"
      ],
      "書影音": [
        "我看了很多書，主要是書名。",
        "影評像人生建議：看懂了不一定照做。",
        "歌單在循環，生活在原地。",
        "{KW}像片尾彩蛋，等到了也就那樣。"
      ],
      "專案管理": [
        "排程像多米諾，倒的永遠比立起來的快。",
        "風險登錄表很長，睡眠時長很短。",
        "交付是終點，也是下一個坑的起點。",
        "{KW}不是阻塞，是大家共同的藉口。"
      ]
    };

    // =============== 成人語料庫（雙關 / 露骨 18+） ===============
    // 僅限成年、自願情境；生成時將進行安全檢查（排除未成年、亂倫、非自願、獸交等）
    const CORPUS_ADULT = {
      "成人-雙關": [
        "今晚的流程寫好了：前戲暖場，正題兩回，加映抱著睡。",
        "把理智放進抽屜，把你放在我心上，順便放在我身上。",
        "想跟你做道題：先口算，再筆算，最後心算到天亮。",
        "燈先關一盞，膽子就敢一寸。",
        "{KW}當安全詞，說到它就暫停，沒說就別停。",
        "房門像Bug，一關就不想修；只想讓你修我。",
        "今晚的KPI：你滿意、我滿身、床滿分。",
        "想和你開個會，議程只有一項：彼此同意，直到彼此同意。",
        "別聊宇宙的盡頭了，聊聊我們的盡頭碰到盡頭。",
        "把專案拆成任務，把你拆成親一口、抱一下、到最後。"
      ],
      "成人-露骨": [
        "我想用舌頭把你今天的不快一點點舔掉，直到你只剩顫抖和笑。",
        "口紅別擦，我想沿著顏色一路親下去，停在你讓我停的地方。",
        "把{KW}當安全詞，你說出口就換慢速；沒說，就別讓我停。",
        "想看你跨坐在我身上，抓著我不放，像騎著人生第一次對的方向鍵。",
        "今晚不要客套，想把你從牆邊吻到床邊，再從床邊吻回牆邊。",
        "你的喘息像節拍器，我用身體對齊節奏，直到我們同時失控。",
        "把雙手借給我，其他交給我；等會兒把聲音借給鄰居。",
        "我喜歡你說臟話的樣子，就像白噪音蓋住全世界，只剩我們的聲音。",
        "把理智留到明天，今晚只想把你填滿到沒空想別的。",
        "不必假裝矜持，把你的濕熱交給我，我會把我的全部都交回去。",
        "我要慢慢進，讓你清楚記得每一寸；也要快快退，讓你更捨不得我。",
        "我想把你抱到失重，親到失語，做愛做到失眠。",
        "不要問我愛不愛你，先讓我進去，讓答案自己濕出來。"
      ]
    };

    // =============== 模板碎片 ===============
    const FRAG = {
      OPEN: ["講真，","嚴肅一點，","不開玩笑，","我有個不成熟的小建議：","據路邊社統計，","寫在前面：","道理先放一邊，","我先胡說兩句：","別急著反駁，"],
      CLAIM: [
        "道理都懂，做起來全忘","計畫趕不上變化","清醒的人最難快樂","體面有時比正確重要","大家都很忙，忙著顯得不忙",
        "說穿了也就那麼回事","故事需要轉場，人生需要轉身","大道理裝口袋，小情緒放臉上","輸出幹話比輸出價值簡單多了"
      ],
      TURN: ["說白了就是","說好聽是","別繞彎了，其實是","話別說滿，歸根到底是","核心問題永遠是","總之","但話說回來，"],
      PUNCH: [
        "求的是體面，不是體現","情緒先到位，邏輯慢慢補","我們需要的是掌聲，不是掌控","先把檔做漂亮，再把事做明白",
        "把複雜的留給明天，把好聽的留給今天","有沒有用再說，先好笑再算","沒解決問題，先解決畫面",
        "靠{KW}撐場面，靠沉默撐氣質","把{NOUN}說成故事，把{KW}說成傳說"
      ],
      TAIL: ["。","。{EMOJI}","。——懂的自然懂","。不懂也正常","。歡迎反駁，反駁無效"]
    };

    const TEMPLATES = [
      "{OPEN}{CLAIM}，{TURN}{PUNCH}{TAIL}",
      "{OPEN}{KW}這件小事，{CLAIM}；大概懂了什麼叫{NOUN}。",
      "{OPEN}{THEME}不複雜，複雜的是我們想把它說得複雜。",
      "{OPEN}聽過很多道理，決定先把{KW}放一邊，{PUNCH}",
      "{OPEN}所謂成熟，就是學會在{NOUN}裡面假裝清醒。",
      "{OPEN}有人靠天賦，有人靠努力，我靠{KW}和運氣站起來的錯覺。",
      "{OPEN}別把真心話說太滿，把幹話留點空，{PUNCH}",
      "{KW}不是解法，是個提醒：{CLAIM}，{PUNCH}",
      "{KW}像{NOUN}，看起來有份量，落地只剩形狀。",
      "{KW}在左，{NOUN}在右；前路不明，情緒先到。",
      "{THEME}有流程，{KW}沒劇本；人設要體面，心事要體諒。",
      "別和{NOUN}爭辯，它會用時間把你說服。",
      "當{NOUN}開始解釋，一切就變得更{ADJ}。",
      "把話說滿的人，常把事做空；把{KW}說輕的人，才知道它有多重。",
      "你以為我在輸出價值，其實我在輸出情緒；你以為{KW}在幫忙，其實在添堵。"
    ];

    // 成人模板（雙關/露骨）
    const TEMPLATES_ADULT = {
      hint: [
        "今晚把{KW}當安全詞，先暖場，再正題，最後抱緊處理。",
        "請把理智放抽屜，把我放進你心裡，順便放在你身上。",
        "我們來對齊節奏：前奏慢一點，副歌重一點，{KW}喊了就停一點。"
      ],
      explicit: [
        "我想用舌頭沿著你最敏感的地方慢慢畫圓，直到你記不住{KW}。",
        "你跨坐在我身上，我抓住你的腰，節奏一快我們就同時失控。",
        "今晚別讓我客氣，把你填滿到再也騙不了身體。"
      ]
    };

    // =============== 安全過濾（純淨 + 成人安全） ===============
    // 取消純淨模式：不再過濾詞彙
    function filterDirty(text){ return text; }
    // 成人安全：排除未成年/亂倫/非自願/獸交等字眼
    const BLOCK_MINOR = ["未成年","未滿18","未滿十八","小孩","兒童","嬰兒","國中生","高中生","小學生","女童","男童","童顏","蘿莉","正太"];
    const BLOCK_INCEST = ["爸","父","母","媽","公公","婆婆","岳父","岳母","繼父","繼母","哥哥","弟弟","姐姐","妹妹","表哥","表弟","表姐","表妹","堂哥","堂弟","堂姐","堂妹","叔","伯","舅","姨","姑"];
    const BLOCK_BESTIALITY = ["狗","貓","馬","獸交","動物","寵物"];
    const BLOCK_NONCONSENT = ["強迫","強上","硬上","迷奸","下藥","被迫","不情願","性侵","偷拍"];
    function adultSafetyOk(s){
      const all = [...BLOCK_MINOR, ...BLOCK_INCEST, ...BLOCK_BESTIALITY, ...BLOCK_NONCONSENT];
      return !all.some(k=>s.includes(k));
    }

    // =============== 生成邏輯 ===============
    function buildContext({kw, theme, styleText}){
      return {
        KW: kw || "",
        THEME: theme || "",
        NOUN: pick(LEX.NOUN),
        ADJ: pick(LEX.ADJ),
        VERB: pick(LEX.VERB),
        EMOJI: pick(LEX.EMOJI),
        OPEN: pick(FRAG.OPEN),
        CLAIM: pick(FRAG.CLAIM),
        TURN: pick(FRAG.TURN),
        PUNCH: replaceSmart(pick(FRAG.PUNCH), {KW: kw || "這件事", NOUN: pick(LEX.NOUN)}),
        TAIL: pick(FRAG.TAIL)
      }
    }
    function fromTemplate(ctx, tplList=TEMPLATES){
      const tpl = pick(tplList);
      return replaceSmart(tpl, ctx);
    }

    function poolForTheme(theme, adultOn){
      // 成人主題控制：未開啟成人模式，選成人主題時回退
      if(theme === "成人-雙關"){
        if(adultOn) return CORPUS_ADULT["成人-雙關"];
        return CORPUS["情感"]; // 回退
      }
      if(theme === "成人-露骨"){
        if(adultOn) return CORPUS_ADULT["成人-露骨"];
        return CORPUS["情感"]; // 回退
      }
      return CORPUS[theme] || [];
    }

    function dedupeLines(lines, mode="soft"){
      if(mode==="off") return lines;
      const seen = new Set();
      const out = [];
      for(const s of lines){
        const key = mode==="strict" ? s.replace(/[，。、！!？?\s]/g,"") : s.replace(/[。.!?\s]/g,"");
        if(!seen.has(key)){ seen.add(key); out.push(s); }
      }
      return out;
    }

    function fromCorpus({theme, kw, creativity, adultOn}){
      const th = theme==="random" ? pick(Object.keys(CORPUS)) : theme;
      let pool = poolForTheme(th, adultOn);
      if(pool.length===0){ pool = [].concat(...Object.values(CORPUS)); }

      // 以創意度決定模板/語料比例
      const pTemplate = clamp((creativity/100), 0.25, 0.85);
      const useTpl = Math.random() < pTemplate;

      let sentence = "";
      if(useTpl){
        // 成人模板：依主題決定 hint/explicit
        if(th==="成人-雙關" && adultOn){
          const ctx = buildContext({kw, theme: th});
          sentence = fromTemplate(ctx, TEMPLATES_ADULT.hint);
        }else if(th==="成人-露骨" && adultOn){
          const ctx = buildContext({kw, theme: th});
          sentence = fromTemplate(ctx, TEMPLATES_ADULT.explicit);
        }else{
          const ctx = buildContext({kw, theme: th});
          sentence = fromTemplate(ctx);
        }
      }else{
        sentence = pick(pool);
        sentence = replaceSmart(sentence, {KW: kw || "", THEME: th});
      }
      // 成人模式不做內容安全過濾（依需求）
      sentence = filterDirty(sentence);
      return sentence;
    }

    function genLocal(){
      const themeSel = byId("theme").value;
      const themeCustom = byId("themeCustom").value.trim();
      const kw = byId("keyword").value.trim();
      const format = byId("format").value;
      let count = parseInt(byId("count").value || "1",10);
      const creativity = parseInt(byId("creativity").value||"60",10);
      const dedupeMode = byId("dedupe").value;
      const adultOn = byId("adultOn").checked;

      const thFinal = themeCustom || (themeSel==="random" ? "random" : themeSel);

      // 規則：對聯固定2句；其他格式尊重使用者 count（包含 poster）
      if(format==="couplet") count = 2;
      if(format==="single") count = 1;

      const lines = [];
      const triesMax = Math.max(20, count*3);
      let tries=0;
      while(lines.length < count && tries < triesMax){
        const s = fromCorpus({theme: thFinal, kw, creativity, adultOn});
        lines.push(s);
        tries++;
      }
      const deduped = dedupeLines(lines, dedupeMode);
      // 若去重後不足量，再補齊
      while(deduped.length < count && tries < triesMax*2){
        deduped.push(fromCorpus({theme: thFinal, kw, creativity, adultOn}));
        tries++;
      }
      return {lines: deduped.slice(0, count), theme: thFinal, kw, format, adultOn};
    }

    // =============== 輸出格式化 ===============
    function formatOutput({lines, format}){
      let text="";
      if(format==="single"){
        text = lines[0] || "";
      }else if(format==="list"){
        text = lines.map((s,i)=>`• ${s}`).join("\n");
      }else if(format==="paragraph"){
        text = lines.join(" ");
      }else if(format==="couplet"){
        const up = (lines[0]||"").replace(/^上聯[:：]?/,"");
        const down = (lines[1]||"").replace(/^下聯[:：]?/,"");
        text = `上聯：${up}\n下聯：${down}`;
      }else if(format==="poster"){
        text = lines.map(s=>"「"+s+"」").join("\n");
      }else{
        text = lines.join("\n");
      }
      return text.trim();
    }

    function updateTags(info){}

    // =============== UI 綁定：模式切換 / 動態欄位 ===============
    // 點擊主介面時關閉小視窗 + 保證同時只開一個
    const detailEls = [byId('aiDetails'), byId('adultDetails')].filter(Boolean);
    function closeAllDetails(){ detailEls.forEach(d=>{ if(d && d.open) d.open=false; }); }
    document.addEventListener('click', (e)=>{
      const withinDetails = e.target.closest && e.target.closest('details');
      if(!withinDetails){ closeAllDetails(); }
      // 僅允許單一 details 開啟
      const opened = detailEls.filter(d=>d.open);
      if(opened.length>1){ opened.slice(1).forEach(d=>d.open=false); }
    });

    function refreshCountState(){
      const format = byId("format").value;
      const count = byId("count");
      const label = byId("countLabel");
      const themeSelect = byId('theme');
      const themeCustom = byId('themeCustom');
      const styleSelect = byId('style');
      const styleCustom = byId('styleCustom');
      if(format==="single"){
        count.disabled = true;
        label.textContent = "數量/句數（單句固定 1）";
      }else if(format==="couplet"){
        count.disabled = true;
        label.textContent = "數量/句數（對聯固定 2）";
      }else{
        count.disabled = false;
        label.textContent = "數量/句數";
      }
      // 自定義主題/風格的輸入啟用
      if(themeSelect && themeCustom){ themeCustom.disabled = themeSelect.value !== 'custom'; }
      if(styleSelect && styleCustom){ styleCustom.disabled = styleSelect.value !== 'custom'; }
    }
    byId("format").addEventListener("change", refreshCountState);
    byId("theme").addEventListener("change", refreshCountState);
    byId("style").addEventListener("change", refreshCountState);
    // 首次載入時套用主題/風格自定義 disable 狀態
    refreshCountState();

    // =============== 本地模式：生成 / 隨機 / 清空 ===============
    async function genAIUsingMainInputs(){
      const base = byId("apiBase").value.trim() || "https://api.openai.com/v1";
      const key = byId("apiKey").value.trim();
      const model = byId("apiModel").value.trim() || "gpt-4o-mini";
      const themeSel = byId("theme").value;
      const themeCustom = byId("themeCustom").value.trim();
      const kw = byId("keyword").value.trim();
      const format = byId("format").value;
      let n = parseInt(byId("count").value||"4",10);
      const creativity = parseInt(byId("creativity").value||"60",10);
      const dedupeMode = byId("dedupe").value;
      const adultOn = byId("adultOn").checked;
      if(format==="single") n = 1; else if(format==="couplet") n = 2;
      if(!key){ toast("請輸入 API Key"); return; }

      // 保存 AI 設定
      setLocal("AI__base", base);
      setLocal("AI__model", model);
      setLocal("AI__key", key);
      setLocal("AI__adultOn", adultOn);

      const theme = themeCustom || (themeSel==="random"? "" : themeSel);
      const sys = buildSystemPrompt({adultOn, theme});
      const styleSel = byId('style').value;
      const styleCustom = byId('styleCustom').value.trim();
      const styleText = styleCustom || (styleSel && styleSel!=='正常' ? styleSel : '');
      const user = `以「${theme || '幹話'}」為主題，結合關鍵字「${kw || '（無）'}」，請產生 ${n} 句${adultOn?"成人":"幹話"}。要求：每句都要「看似合理、實則無用」，避免提供可執行建議；自然嵌入關鍵字${styleText?`，整體風格呈現「${styleText}」`:''}；嚴禁列舉或編號、避免任何引號，只輸出句子本身。`;

      const payload = {
        model,
        temperature: Math.max(0, Math.min(1, creativity/100)),
        n: 1,
        max_tokens: 800,
        messages: [
          {role:"system", content: sys},
          {role:"user", content: user}
        ]
      };

      const controller = new AbortController();
      aiAbort = controller;
      toastLoading("AI 生成中...");
      try{
        const res = await fetch(`${base}/chat/completions`, {
          method:"POST",
          headers:{"Content-Type":"application/json","Authorization":`Bearer ${key}`},
          body: JSON.stringify(payload),
          signal: controller.signal
        });
        if(!res.ok){ const t=await res.text(); throw new Error(`API 錯誤：${res.status} ${t}`); }
        const json = await res.json();
        let content = json.choices?.[0]?.message?.content || "";
        let lines = content.split(/\r?\n/).map(s=>s.trim()).filter(Boolean)
          .map(s=>s.replace(/^[-•\d]+\s*/,""))
          .map(s=>s.replace(/^([「“"'])(.*)([」”"'])$/,'$2'));
        lines = dedupeLines(lines, dedupeMode);
        if(lines.length>n) lines = lines.slice(0,n);
        lines = lines.map(filterDirty);
        await typeLines(byId("output"), lines, 14, 120);
      }catch(err){
        if(err.name!=="AbortError"){ console.error(err); toast("AI 生成失敗："+err.message); }
      }finally{
        toastDone();
        aiAbort=null;
      }
    }

    byId("btn-gen-local").addEventListener("click", async ()=>{
      const useAI = !!byId("aiEnabled") && byId("aiEnabled").checked;
      if(useAI){ await genAIUsingMainInputs(); return; }
      const res = genLocal();
      let out = formatOutput(res);
      out = sanitizeTextByFormat(out, res.format);
      updateTags(res);
      const lines = out.split(/\n/);
      await typeLines(byId("output"), lines, 14, 120);
    });

    byId("btn-rand").addEventListener("click", ()=>{
      byId("theme").selectedIndex = rand(byId("theme").options.length);
      const kws = ["阿宏","阿芬","保溫瓶","滑鼠","主管","晚自習","KPI","OKR","續命咖啡","週會","情緒價值","便利貼"];
      byId("keyword").value = Math.random()<0.6 ? pick(kws) : "";
      const fmts = ["single","list","paragraph","poster","couplet"];
      byId("format").value = pick(fmts);
      byId("count").value = 2 + rand(5);
      byId("creativity").value = 40 + rand(61);
      byId("dedupe").value = pick(["soft","strict","off"]);
      byId("adultOn").checked = Math.random() < 0.5;
      refreshCountState();
      toast("已隨機調好配方");
    });

    byId("btn-clear").addEventListener("click", ()=>{
      $("#output").textContent="";
      $("#tags-info").innerHTML="";
    });

    // =============== 一鍵複製 / Share ===============
    byId("btn-copy-all").addEventListener("click", async ()=>{
      const text = $("#output").textContent.trim();
      if(!text){ toast("沒有內容可複製"); return; }
      try{
        await navigator.clipboard.writeText(text);
        toast("已複製到剪貼簿");
      }catch(e){
        toast("複製失敗");
      }
    });

    // 已取消分享功能

    // =============== 設定持久化（即時） ===============
    // 保存 AI & 成人設定 + AI 開關
    ["apiBase","apiModel","apiKey"].forEach(id=>{
      const el = byId(id);
      if(!el) return;
      el.addEventListener("input", ()=>{
        const v = (el.value||"").trim();
        setLocal(`AI__${id.replace('api','').toLowerCase()}`, v);
      });
    });
    const aiEnabledEl = byId("aiEnabled"); if(aiEnabledEl){ aiEnabledEl.addEventListener("change", e=> setLocal("AI__aiEnabled", e.target.checked)); }
    ["adultOn","adultFull"].forEach(id=>{ const el=byId(id); if(el){ el.addEventListener("change", e=> setLocal(`AI__${id}`, e.target.checked)); }});

    // =============== AI 模式：系統提示詞（依成人模式自動） ===============
    const buildSystemPrompt = ({adultOn, theme})=>{
      const styleSel = byId('style').value;
      const styleCustom = byId('styleCustom').value.trim();
      const styleText = styleCustom || (styleSel && styleSel!=='正常' ? styleSel : '');
      const adultFull = !!byId('adultFull') && byId('adultFull').checked;
      return buildSystemPromptFromState({adultOn, adultFull, theme, customAdult: byId('adultCustomPrompt')?.value || '', styleText});
    };

    let aiAbort = null;
    const btnGenAI = byId("btn-gen-ai");
    const btnAIStop = byId("btn-ai-stop");
    if(btnGenAI){ btnGenAI.addEventListener("click", async ()=>{
      const base = byId("apiBase").value.trim() || "https://api.openai.com/v1";
      const key = byId("apiKey").value.trim();
      const model = byId("apiModel").value.trim() || "gpt-4o-mini";
      const theme = byId("aiTheme").value.trim();
      const kw = byId("aiKeyword").value.trim();
      const n = parseInt(byId("aiCount").value||"6",10);
      const temp = parseInt(byId("aiTemp").value||"70",10)/100;
      const dedupeMode = byId("aiDedupe").value;
      const adultOn = byId("adultOn").checked;
      if(!key){ toast("請輸入 API Key"); return; }
      // 保存 AI 設定
      setLocal("AI__base", base);
      setLocal("AI__model", model);
      setLocal("AI__key", key);
      setLocal("AI__adultOn", adultOn);

      const sys = (byId("aiCustomSystem").value.trim() || buildSystemPrompt({adultOn, theme}));
      const user = `請產生 ${n} 句${adultOn?"成人":"幹話"}。關鍵字（可留空）：${kw ? kw : "（無）"}`;

      const payload = {
        model, temperature: temp, n: 1, max_tokens: 800,
        messages: [
          {role:"system", content: sys},
          {role:"user", content: user}
        ]
      };

      const controller = new AbortController();
      aiAbort = controller;
      if(btnGenAI) btnGenAI.classList.add("hidden");
      if(btnAIStop) btnAIStop.classList.remove("hidden");
      try{
        const res = await fetch(`${base}/chat/completions`, {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":`Bearer ${key}`
          },
          body: JSON.stringify(payload),
          signal: controller.signal
        });
        if(!res.ok){
          const t=await res.text();
          throw new Error(`API 錯誤：${res.status} ${t}`);
        }
        const json = await res.json();
        let content = json.choices?.[0]?.message?.content || "";
        let lines = content.split(/\r?\n/).map(s=>s.trim()).filter(Boolean)
          .map(s=>s.replace(/^[-•\d]+\s*/,""))
          .map(s=>s.replace(/^([「“"'])(.*)([」”"'])$/,'$2'))
          .filter(Boolean);
        // 去重
        lines = dedupeLines(lines, dedupeMode);
        if(lines.length>n) lines = lines.slice(0,n);
        lines = lines.map(filterDirty);
        // 標點修復
        lines = sanitizeLines(lines);
        const out = formatOutput({lines, format:"list"});
        await typeLines(byId("output"), out.split(/\n/), 14, 120);
        updateTags({theme: theme || (adultOn?"成人":undefined), kw, format:"list"});
      }catch(err){
        if(err.name!=="AbortError"){
          console.error(err);
          toast("AI 生成失敗："+err.message);
        }
      }finally{
        if(btnGenAI) btnGenAI.classList.remove("hidden");
        if(btnAIStop) btnAIStop.classList.add("hidden");
        aiAbort = null;
      }
    }); }
    if(btnAIStop){ btnAIStop.addEventListener("click", ()=>{ if(aiAbort){ aiAbort.abort(); toast("已停止"); } }); }

    // =============== Console 指令：顯示目前提示詞（System/User） ===============
    // 用法：
    // ghPrompt()                           // 依目前介面設定輸出 System/User 提示詞
    // ghPrompt({ theme:"自定主題", kw:"關鍵字", n:6, style:"毒舌", adultOn:true, adultFull:false }) // 覆寫預設
    function computeStyleText(){
      const styleSel = byId('style')?.value || '';
      const styleCustom = byId('styleCustom')?.value?.trim() || '';
      return styleCustom || (styleSel && styleSel!== '正常' && styleSel!== 'custom' ? styleSel : '');
    }
    function computeTheme(){
      const sel = byId('theme')?.value || 'random';
      const custom = byId('themeCustom')?.value?.trim() || '';
      if(sel === 'custom') return custom;
      if(sel === 'random') return '';
      return sel;
    }
    function computeN(){
      const fmt = byId('format')?.value || 'list';
      let n = parseInt(byId('count')?.value||'4',10);
      if(fmt === 'single') n = 1; else if(fmt === 'couplet') n = 2;
      return n;
    }
    function buildUserPrompt({n, adultOn, theme, kw, styleText}){
      return `以「${theme || '幹話'}」為主題，結合關鍵字「${kw || '（無）'}」，請產生 ${n} 句${adultOn?"成人":"幹話"}。要求：每句都要「看似合理、實則無用」，避免提供可執行建議；自然嵌入關鍵字${styleText?`，整體風格呈現「${styleText}」`:''}；嚴禁列舉或編號、避免任何引號，只輸出句子本身。`;
    }
    window.ghPrompt = (overrides={})=>{
      const adultOn = overrides.adultOn != null ? !!overrides.adultOn : !!(byId('adultOn')?.checked);
      const adultFull = overrides.adultFull != null ? !!overrides.adultFull : !!(byId('adultFull')?.checked);
      const theme = overrides.theme != null ? overrides.theme : computeTheme();
      const kw = overrides.kw != null ? overrides.kw : (byId('keyword')?.value?.trim() || '');
      const styleText = overrides.style != null ? overrides.style : computeStyleText();
      const n = overrides.n != null ? overrides.n : computeN();
      const sys = buildSystemPromptFromState({ adultOn, adultFull, theme, customAdult: byId('adultCustomPrompt')?.value || '', styleText });
      const user = buildUserPrompt({ n, adultOn, theme, kw, styleText });
      console.log('[System Prompt]\n'+sys+'\n\n[User Prompt]\n'+user);
      return { system: sys, user };
    };

    function measureWrappedText(text, maxWidth, font, lineHeightPx, align){
      ctx.font = font; ctx.textAlign = align || "left"; ctx.textBaseline = "top";
      const linesOut = [];
      const paragraphs = text.split(/\n+/).map(s=>s.trim()).filter(s=>s.length>0);
      for(const p of paragraphs){
        // 中文逐字、英文單詞混合換行
        let line = "";
        const tokens = /[\p{Script=Han}。，、？！：；（）「」『』【】《》…—]|[^\s\p{Script=Han}。，、？！：；（）「」『』【】《》…—]+/gu;
        const parts = p.match(tokens) || [p];
        for(const part of parts){
          const test = line + part;
          if(ctx.measureText(test).width > maxWidth){
            if(line) linesOut.push(line);
            // 若單個 part 超寬，做中斷
            if(ctx.measureText(part).width > maxWidth){
              let sub=""; for(const ch of part){
                const t2=sub+ch;
                if(ctx.measureText(t2).width>maxWidth){ linesOut.push(sub); sub=ch; } else { sub=t2; }
              }
              if(sub) line=sub;
            }else{
              line = part;
            }
          }else{
            line = test;
          }
        }
        if(line) linesOut.push(line);
        linesOut.push(""); // 段落空行
      }
      if(linesOut.length && linesOut[linesOut.length-1]==="") linesOut.pop();
      const height = linesOut.reduce((h, ln)=>h + (ln===""? lineHeightPx*0.6 : lineHeightPx), 0);
      return {lines: linesOut, height};
    }

    function drawTextBlock(opts){
      const {text, style, padding, fontScale, watermark, align, lineHeight, strokeWidth, maskRadius, autoFit} = opts;
      const W=parseInt(canvas.style.width), H=parseInt(canvas.style.height);
      let content = text.trim() || "先生成幹話，再做成圖。";
      const base = Math.round((Math.min(W,H)/24) * (fontScale/100));
      const linePx = Math.max(14, Math.round(base * (lineHeight/100)));
      // 背景遮罩
      if(style!=="meme"){
        ctx.fillStyle="rgba(0,0,0,0.22)";
        roundRect(ctx, padding, padding, W-2*padding, H-2*padding, maskRadius, true, false);
      }
      if(style==="meme"){
        // MEME：上/下
        const lines = content.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        const top = (lines[0]||"上方那句").toUpperCase();
        const bottom = (lines.length>1? lines[lines.length-1] : "下方那句").toUpperCase();
        const drawImpact = (t, y)=>{
          let fs = base*1.25;
          ctx.textAlign="center"; ctx.textBaseline="top";
          ctx.fillStyle="#fff"; ctx.strokeStyle="#000";
          // 自動適配
          while(ctx.measureText(t).width > W - padding*2){ fs -= 2; ctx.font = `bold ${fs}px Impact, Arial Black, system-ui, sans-serif`; }
          ctx.font = `bold ${fs}px Impact, Arial Black, system-ui, sans-serif`;
          ctx.lineWidth = Math.max(2, strokeWidth || Math.round(fs*0.08));
          // 分行
          const arr = wrapForMeme(t, W - padding*2, fs);
          let yy = y;
          for(const line of arr){
            ctx.strokeText(line, W/2, yy);
            ctx.fillText(line, W/2, yy);
            yy += fs*1.15;
          }
        };
        drawImpact(top, padding*0.8);
        drawImpact(bottom, H - padding*0.8 - base*1.2*wrapForMeme(bottom, W-padding*2, base*1.15).length);
      }else if(style==="quote"){
        let fs = base*1.05;
        let font = `600 ${fs}px system-ui, "Noto Sans TC", sans-serif`;
        let measure = measureWrappedText(content, W - padding*2.2, font, linePx, align);
        if(autoFit==="on"){
          while((measure.height > H - padding*2.2) && fs>12){
            fs -= 1;
            font = `600 ${fs}px system-ui, "Noto Sans TC", sans-serif`;
            measure = measureWrappedText(content, W - padding*2.2, font, Math.max(12, Math.round(fs*lineHeight/100)), align);
          }
        }
        ctx.font = font;
        ctx.textAlign = align; ctx.textBaseline="top";
        ctx.fillStyle = "#fff"; ctx.strokeStyle = "rgba(0,0,0,0.65)";
        ctx.lineWidth = strokeWidth;
        // 引號
        ctx.shadowColor="rgba(0,0,0,.5)"; ctx.shadowBlur=8; ctx.shadowOffsetY=2;
        ctx.fillText("“", align==="left"? padding*1.3 : (align==="center"? W/2 : W - padding*1.3), padding*1.0);
        // 內容
        ctx.shadowBlur=0; ctx.shadowOffsetY=0;
        let y = padding*1.6;
        const startX = align==="left"? padding*1.3 : (align==="center"? W/2 : W - padding*1.3);
        for(const line of measure.lines){
          if(line===""){ y += linePx*0.6; continue; }
          if(strokeWidth>0) ctx.strokeText(line, startX, y);
          ctx.fillText(line, startX, y);
          y += linePx;
        }
      }else{ // poster
        let fs = base*1.15;
        let font = `800 ${fs}px system-ui, "Noto Sans TC", sans-serif`;
        let measure = measureWrappedText(content, W - padding*2.2, font, linePx, align);
        if(autoFit==="on"){
          while((measure.height > H - padding*2.2) && fs>12){
            fs -= 1;
            font = `800 ${fs}px system-ui, "Noto Sans TC", sans-serif`;
            measure = measureWrappedText(content, W - padding*2.2, font, Math.max(12, Math.round(fs*lineHeight/100)), align);
          }
        }
        ctx.font = font;
        ctx.textAlign = align; ctx.textBaseline="top";
        ctx.fillStyle = "#fff"; ctx.strokeStyle = "rgba(0,0,0,0.75)";
        ctx.lineWidth = strokeWidth;
        let y = (H - measure.height)/2;
        const startX = align==="left"? padding*1.2 : (align==="center"? W/2 : W - padding*1.2);
        for(const line of measure.lines){
          if(line===""){ y += linePx*0.6; continue; }
          if(strokeWidth>0) ctx.strokeText(line, startX, y);
          ctx.fillText(line, startX, y);
          y += linePx;
        }
      }
      // 浮水印
      if(watermark){
        ctx.save();
        ctx.globalAlpha=0.85;
        const wmSize = Math.round(base*0.72);
        ctx.font = `600 ${wmSize}px system-ui, "Noto Sans TC", sans-serif`;
        ctx.fillStyle="rgba(255,255,255,0.88)";
        ctx.textAlign="right"; ctx.textBaseline="bottom";
        ctx.fillText(watermark, W - padding, H - padding*0.8);
        ctx.restore();
      }
    }

    function wrapForMeme(text, maxWidth, fs){
      const words = text.split(/\s+/);
      let lines = []; let line="";
      ctx.font = `bold ${fs}px Impact, Arial Black, system-ui, sans-serif`;
      for(let i=0;i<words.length;i++){
        const w = words[i];
        const test = line ? line + " " + w : w;
        if(ctx.measureText(test).width > maxWidth){
          if(line) lines.push(line);
          line = w;
        }else{
          line = test;
        }
      }
      if(line) lines.push(line);
      if(lines.length===1 && /\p{Script=Han}/u.test(text) && !/\s/.test(text)){
        // 中文逐字分割
        const arr = []; let cur="";
        for(const ch of text){
          const t = cur+ch;
          if(ctx.measureText(t).width > maxWidth){ arr.push(cur); cur=ch; } else { cur=t; }
        }
        if(cur) arr.push(cur);
        return arr;
      }
      return lines;
    }

    function roundRect(ctx, x, y, w, h, r, fill, stroke){
      if (w < 2 * r) r = w / 2;
      if (h < 2 * r) r = h / 2;
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y, x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x, y+h, r);
      ctx.arcTo(x, y+h, x, y, r);
      ctx.arcTo(x, y, x+w, y, r);
      ctx.closePath();
      if (fill) ctx.fill();
      if (stroke) ctx.stroke();
    }

    // =============== 預設生成 ===============
    (function init(){
      // 載入 LocalStorage 設定（AI 與成人模式）
      const savedBase = getLocal("AI__base", "https://api.openai.com/v1");
      const savedModel = getLocal("AI__model", "gpt-4o-mini");
      const savedKey = getLocal("AI__key", "");
      const savedAdult = getLocal("AI__adultOn", false);
      const savedAdultFull = getLocal("AI__adultFull", false);
      const savedAiEnabled = getLocal("AI__aiEnabled", false);
      if(savedBase) byId("apiBase").value = savedBase;
      if(savedModel) byId("apiModel").value = savedModel;
      if(typeof savedKey === 'string') byId("apiKey").value = savedKey;
      byId("adultOn").checked = !!savedAdult;
      const adultFullEl = byId("adultFull"); if(adultFullEl) adultFullEl.checked = !!savedAdultFull;
      const aiEnabledEl2 = byId("aiEnabled"); if(aiEnabledEl2) aiEnabledEl2.checked = !!savedAiEnabled;

      const res = genLocal();
      const out = formatOutput(res);
      $("#output").textContent = out;
      updateTags(res);
      makeImageFromOutput();
    })();
  </script>
</body>
</html>